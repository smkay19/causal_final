---
title: "Kay_Shannon_APSTA_2012_Final"
author: "Shannon Kay"
date: "12/14/2019"
output: html_document
---

```{r}
start.time = Sys.time()
set.seed(2012)

data_function1 <- function(x){
  c <- rep(c("c", "n", "a"), x*c(.5,.3,.2))
  d_0 <- rep(c(0,0,1), x*c(.5, .3, .2))
  d_1 <- rep(c(1,0,1), x*c(.5, .3, .2))
  
  dat<- data.frame(d_0, d_1, c)

  comp_Y0 <- rnorm(x*.5, 80, 3.5)
  nev.taker_Y0 <- rnorm(x*.3,75,7)
  always_Y0 <- rnorm(x*.2,87,3.5)

  Y0 <- c(comp_Y0, nev.taker_Y0, always_Y0)

  comp_Y1 <- rnorm(x*.5,89,3.5)
  nev.taker_Y1 <- rnorm(x*.3,75,7)
  always_Y1 <- rnorm(x*.2,87,3.5)

  Y1 <- c(comp_Y1, nev.taker_Y1, always_Y1)
  
  age <- rnorm(x,20,.5)
  gender <- rbinom(x, size = 1, prob = .5)
  
  comp_attend_Z0 <- rep(0,.5*x)
  nev.taker_attend <- rep(0,.3*x)
  always_attend <- rep(1,.2*x)

  ##varying attendance for compliers
  ## % of attendance for compliers skewed lower- students attend once or twice and dwindle off
  comp_attend1_Z1 <- rbeta(.5*x,shape1 = 2, shape2 = 15)
  ## % of attendance for compliers  
  comp_attend2_Z1 <- rbeta(.5*x,shape1 = 2, shape2 = 2)
  ## % attendance for compliers 
  comp_attend3_Z1 <- rbeta(.5*x,shape1 = 2, shape2 = .5)

  attend_Z0 <- c(comp_attend_Z0, nev.taker_attend, always_attend)
  attend1_Z1 <- c(comp_attend1_Z1, nev.taker_attend, always_attend)
  attend2_Z1 <- c(comp_attend2_Z1, nev.taker_attend, always_attend)
  attend3_Z1 <- c(comp_attend3_Z1, nev.taker_attend, always_attend)
  
  Z <- rbinom(x, size = 1, prob = .5)

  god.dat <- data.frame(d_0, d_1, c, Y0, Y1, age, gender, attend_Z0, attend1_Z1, attend2_Z1, attend3_Z1, Z)
  
  Y_obs <- ifelse(god.dat$Z== 1, god.dat$Y1, god.dat$Y0)
  D_obs <- ifelse(god.dat$Z == 1, god.dat$d_1, god.dat$d_0)
  
  attend1_obs <- ifelse(god.dat$Z== 1, god.dat$attend1_Z1, god.dat$attend_Z0)
  attend2_obs <- ifelse(god.dat$Z== 1, god.dat$attend2_Z1, god.dat$attend_Z0)
  attend3_obs <- ifelse(god.dat$Z== 1, god.dat$attend3_Z1, god.dat$attend_Z0)

  sim.dat.obs <- data.frame(D_obs, god.dat$Z, god.dat$age, god.dat$gender, attend1_obs, attend2_obs, attend3_obs, Y_obs)
  colnames(sim.dat.obs) <- c("D", "Z", "Age", "Gender", "Attend1", "Attend2", "Attend3", "Y")
  
  return(sim.dat.obs)
}


##set # draws, initialize vector to store CACE estimates
draws <- 1000
CACE_ivreg_baseline <- numeric()
CACE_ivreg_2 <- numeric()
CACE_ivreg_3 <- numeric()
CACE_ivreg_4 <- numeric()

for(i in 1:draws){
  sim.dat <- data_function1(50)
  
  ##baseline function
  ivreg.baseline <- ivreg(Y ~ D | Z, data = sim.dat)
  CACE_ivreg_baseline[length(CACE_ivreg_baseline)+1] <- ivreg.baseline$coefficients[2]
  
  ##fit 2
  ivreg.fit2 <- ivreg(Y ~ D + Attend1 | Z, data = sim.dat)
  CACE_ivreg_2[length(CACE_ivreg_2)+1] <- ivreg.fit2$coefficients[2]
  
  ##fit 3
  ivreg.fit3 <- ivreg(Y ~ D + Attend2 | Z, data = sim.dat)
  CACE_ivreg_3[length(CACE_ivreg_3)+1] <- ivreg.fit3$coefficients[2]
  
  ##fit 4
  ivreg.fit4 <- ivreg(Y ~ D + Attend3 | Z, data = sim.dat)
  CACE_ivreg_4[length(CACE_ivreg_4)+1] <- ivreg.fit4$coefficients[2]
  
}

baseline_CACE_std.dev <- sd(CACE_ivreg_baseline)
baseline_CACE_std.dev

baseline_mean_CACE <- mean(CACE_ivreg_baseline)
baseline_mean_CACE

ivreg2_CACE_std.dev <- sd(CACE_ivreg_2)
ivreg2_CACE_std.dev

ivreg2_mean_CACE <- mean(CACE_ivreg_2)
ivreg2_mean_CACE

ivreg3_CACE_std.dev <- sd(CACE_ivreg_3)
ivreg3_CACE_std.dev

ivreg3_mean_CACE <- mean(CACE_ivreg_3)
ivreg3_mean_CACE

ivreg4_CACE_std.dev <- sd(CACE_ivreg_4)
ivreg4_CACE_std.dev

ivreg4_mean_CACE <- mean(CACE_ivreg_4)
ivreg4_mean_CACE

end.time = Sys.time()
total.time = end.time - start.time
```




###Propensity Scores 

```{r}

data_function2 <- function(x){
  Y0 <- rnorm(x*.5, 80, 3.5)
  Y1 <- rnorm(x*.5,89,3.5)

  age <- rnorm(x,20,.5)
  gender <- rbinom(x, size = 1, prob = .5)
  
  attend_z0 <- rep(0,x)

  ##varying attendance for treated
  ## % of attendance for skewed lower- students attend once or twice and dwindle off
  attend1_Z1 <- rbeta(500,shape1 = 2, shape2 = 15)
  ## % of attendance for treated varies between 0-10 
  attend2_Z1 <- rbeta(500,shape1 = 2, shape2 = 2)
  ## % attendance for treated skewed toward 10
  attend3_Z1 <- rbeta(500,shape1 = 2, shape2 = .5)

  Z <- rbinom(x, size = 1, prob = .5)

  god.dat <- data.frame(Y0, Y1, age, gender, attend_Z0, attend1_Z1, attend2_Z1, attend3_Z1, Z)
  
  Y_obs <- ifelse(god.dat$Z== 1, god.dat$Y1, god.dat$Y0)
  
  attend1_obs <- ifelse(god.dat$Z== 1, god.dat$attend1_Z1, god.dat$attend_Z0)
  attend2_obs <- ifelse(god.dat$Z== 1, god.dat$attend2_Z1, god.dat$attend_Z0)
  attend3_obs <- ifelse(god.dat$Z== 1, god.dat$attend3_Z1, god.dat$attend_Z0)

  sim.dat.obs <- data.frame(god.dat$Z, god.dat$age, god.dat$gender, attend1_obs, attend2_obs, attend3_obs, Y_obs)
  colnames(sim.dat.obs) <- c("Z", "Age", "Gender", "Attend1", "Attend2", "Attend3", "Y")
  
  return(sim.dat.obs)
}

matchit_baseline_weights <- numeric()
matchit_fit2_weights <- numeric()
matchit_fit3_weights <- numeric()
matchit_fit4_weights <- numeric()

for(i in 1:draws){
  sim.dat <- data_function1(x)
  
  ##baseline function
  matchit_baseline <- matchit(Z ~ Age + Gender, distance = "nearest", dat = sim.dat)
  ##save weights 
  matchit_baseline_weights <- matchit_baseline$weights
  
  ##fit 2
  matchit_fit2 <- matchit(Z ~ Age + Gender + Attend1, distance = "nearest", dat = sim.dat)
  
  ##fit 3
  matchit_fit3 <- matchit(Z ~ Age + Gender + Attend2, distance = "nearest", dat = sim.dat)
  
  ##fit 4
  matchit_fit4 <- matchit(Z ~ Age + Gender + Attend3, distance = "mahalonobis", dat = sim.dat)
  
}



```
